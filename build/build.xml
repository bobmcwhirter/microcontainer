<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project [
   <!ENTITY buildmagic SYSTEM "../tools/etc/buildmagic/buildmagic.ent">
]>

<!-- ====================================================================== -->
<!--                                                                        -->
<!--  JBoss, the OpenSource J2EE webOS                                      -->
<!--                                                                        -->
<!--  Distributable under LGPL license.                                     -->
<!--  See terms of license at http://www.gnu.org.                           -->
<!--                                                                        -->
<!-- ====================================================================== -->

<!-- $Id$ -->

<project default="main" name="JBossMC/Build">

  <!-- ================================================================== -->
  <!-- Setup                                                              -->
  <!-- ================================================================== -->

  <!--
     | Include the common Buildmagic elements.
     |
     | This defines several different targets, properties and paths.
     | It also sets up the basic extention tasks amoung other things.
   -->

  &buildmagic;


  <!-- ================================================================== -->
  <!-- Initialization                                                     -->
  <!-- ================================================================== -->

  <!--
     | Initialize the build system.  Must depend on '_buildmagic:init'.
     | Other targets should depend on 'init' or things will mysteriously fail.
   -->

  <target name="init" unless="init.disable" depends="_buildmagic:init">
  </target>


  <!-- ================================================================== -->
  <!-- Configuration                                                      -->
  <!-- ================================================================== -->

  <!--
     | Configure the build system.
     |
     | This target is invoked by the Buildmagic initialization logic and
     | should contain module specific configuration elements.
   -->

  <target name="configure" unless="configure.disable">

    <!-- =================== -->
    <!-- Basic Configuration -->
    <!-- =================== -->

    <!-- Module name(s) & version -->
    <property name="module.name" value="jboss"/>
    <property name="module.Name" value="JBossMC Build"/>
    <property name="module.version" value="${version.major}.${version.minor}.${version.revision}${version.tag}"/>

    <!-- ============== -->
    <!-- Modules/Groups -->
    <!-- ============== -->

    <!-- The group to use by default -->
    <property name="groups" value="default"/>

    <!-- Sets up the module configuration. -->
    <moduleconfig property="modules" selected="${groups}">

      <!-- Modules -->
      <module name="container"/>
      <module name="dependency"/>
      <module name="kernel"/>
      <module name="aop-mc-int"/>
      <module name="metatype"/>
      <module name="managed"/>
      <module name="deployers"/>

      <!-- Module groups -->

      <!--this lets you recompile a single module using a command line like
./build.sh -emacs -Dgroups=single -Dsingle-module=server
      -->
      <group name="single">
        <include modules="${single-module}"/>
      </group>

      <group name="core">
        <include modules="container, dependency, kernel, aop-mc-int, metatype, managed, deployers"/>
      </group>

      <group name="default">
        <include groups="core"/>
      </group>

      <group name="most">
        <include groups="core"/>
      </group>

    </moduleconfig>

    <!-- Show the module configuration -->
    <echo>groups:  ${groups}</echo>
    <echo>modules: ${modules}</echo>

    <!-- The combined dependent module classpath -->
    <path id="dependentmodule.classpath">
    </path>

    <!-- ===== -->
    <!-- Tasks -->
    <!-- ===== -->

    <!-- Skip any missing modules and issue a warning -->
    <property name="executemodules.skipmissing" value="true"/>

    <!-- The header and footer displayed during each module execution -->
    <property name="executemodules.header"><![CDATA[
    ======================================================================
    ==  Executing '${target}' in module '${module}'...
    ==]]></property>

    <property name="executemodules.footer"><![CDATA[
    ==
    ==  Finished with '${target}' in module '${module}'.
    ======================================================================
    ]]></property>

    <property name="executemodules.exportproperties">
       version.major,
       version.minor,
       version.revision,
       version.tag,
       version.name,
       version.cvstag,

       specification.title,
       specification.version,
       specification.vendor,

       implementation.title,
       implementation.version,
       implementation.vendor,
       implementation.vendor.id,
       implementation.url
    </property>

    <!-- Bits for building source archives -->
    <patternset id="source.ignore">
      <exclude name="**/output/**"/>
      <exclude name="**/CVS/**" />
    </patternset>
</target>

  <!-- ================================================================== -->
  <!-- Module Pass-through Targets                                        -->
  <!-- ================================================================== -->

  <!--
     | These targets will execute all configured modules with the specified
     | target.
   -->
  <target name="modules-most" depends="_buildmagic:modules:most" />
  <target name="modules-main" depends="_buildmagic:modules:main"/>
  <target name="modules-release" depends="_buildmagic:modules:release"/>
  <target name="modules-tests" depends="_buildmagic:modules:tests"/>
  <target name="modules-clean" depends="_buildmagic:modules:clean"/>
  <target name="modules-clobber" depends="_buildmagic:modules:clobber"/>
  <target name="modules-docs" depends="_buildmagic:modules:docs"/>

  <!-- ================================================================== -->
  <!-- Module Pass-through Hooks                                          -->
  <!-- ================================================================== -->

  <!--
     | These hooks are executed after the above pass-through targets have
     | finished with a given module.
   -->

   <!-- ======== -->
   <!-- Test     -->
   <!-- ======== -->

   <target name="_module-test-most">
     <property name="_module.name" value="test" override="true"/>
     <property name="_module.output" override="true"
           value="${project.root}/${_module.name}/output"/>
   </target>

  <!-- ================================================================== -->
  <!-- Install & Release                                                  -->
  <!-- ================================================================== -->

  <target name="install"
	  description="Install the jars to the jbossbuild repository."
  	  depends="most"
     >
   <fail unless="jbossbuild.repository"
   		message="The jbossbuild.repository.dir property must be set and point to the local jbossbuild repository root"/>
   <fail unless="jbossbuild.repository.version"
   		message="The jbossbuild.repository.version property must be set to the version id (snapshot, 2.0.0.GA, ...)"/>
  	<mkdir dir="${jbossbuild.repository.dir}/jboss/microcontainer/${jbossbuild.repository.version}" />
  	<echo file="${jbossbuild.repository.dir}/jboss/microcontainer/${jbossbuild.repository.version}/component-info.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<project name="jboss/microcontainer-component-info">

   <component id="jboss/microcontainer"
              licenseType="lgpl"
              version="${jbossbuild.repository.version}"
              >
      <artifact id="jboss-aop-mc-int.jar"/>
      <artifact id="jboss-container.jar"/>
      <artifact id="jboss-dependency.jar"/>
      <artifact id="jboss-deployers.jar"/>
      <artifact id="jboss-managed.jar"/>
      <artifact id="jboss-metatype.jar"/>
      <artifact id="jboss-microcontainer.jar"/>
      <artifact id="jboss-aop-mc-int-src.zip"/>
      <artifact id="jboss-container-src.zip"/>
      <artifact id="jboss-dependency-src.zip"/>
      <artifact id="jboss-deployers-src.zip"/>
      <artifact id="jboss-managed-src.zip"/>
      <artifact id="jboss-metatype-src.zip"/>
      <artifact id="jboss-microcontainer-src.zip"/>
      <export>
         <include input="jboss-aop-mc-int.jar"/>
         <include input="jboss-container.jar"/>
         <include input="jboss-dependency.jar"/>
         <include input="jboss-deployers.jar"/>
         <include input="jboss-managed.jar"/>
         <include input="jboss-metatype.jar"/>
         <include input="jboss-microcontainer.jar"/>
      </export>
   </component>

</project>
]]></echo>
  	  <copy todir="${jbossbuild.repository.dir}/jboss/microcontainer/${jbossbuild.repository.version}/lib">  	 
	  		<fileset dir="../aop-mc-int/output/lib">
	  			<include name="*.jar" />
	  			<include name="*-src.zip" />
	  		</fileset>
	  		<fileset dir="../container/output/lib">
	  			<include name="*.jar" />
	  			<include name="*-src.zip" />
	  		</fileset>
	  		<fileset dir="../dependency/output/lib">
	  			<include name="*.jar" />
	  			<include name="*-src.zip" />
	  		</fileset>
	  		<fileset dir="../deployers/output/lib">
	  			<include name="*.jar" />
	  			<include name="*-src.zip" />
	  		</fileset>
	  		<fileset dir="../kernel/output/lib">
	  			<include name="*.jar" />
	  			<include name="*-src.zip" />
	  		</fileset>  	 
	  		<fileset dir="../managed/output/lib">
	  			<include name="*.jar" />
	  			<include name="*-src.zip" />
	  		</fileset>  	 
	  		<fileset dir="../metatype/output/lib">
	  			<include name="*.jar" />
	  			<include name="*-src.zip" />
	  		</fileset>  	 
  	  	</copy>
	<!-- The JDK14 compatible versions -->
  	<mkdir dir="${jbossbuild.repository.dir}/jboss/microcontainer14/${jbossbuild.repository.version}" />
  	<echo file="${jbossbuild.repository.dir}/jboss/microcontainer14/${jbossbuild.repository.version}/component-info.xml"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<project name="jboss/microcontainer-component-info">

   <component id="jboss/microcontainer14"
              licenseType="lgpl"
              version="${jbossbuild.repository.version}"
              >
      <artifact id="jboss-aop-mc-int14.jar"/>
      <artifact id="jboss-container14.jar"/>
      <artifact id="jboss-dependency14.jar"/>
      <artifact id="jboss-microcontainer14.jar"/>
      <export>
         <include input="jboss-aop-mc-int14.jar"/>
         <include input="jboss-container14.jar"/>
         <include input="jboss-dependency14.jar"/>
         <include input="jboss-microcontainer14.jar"/>
      </export>
   </component>

</project>
]]></echo>
  	  <copy todir="${jbossbuild.repository.dir}/jboss/microcontainer14/${jbossbuild.repository.version}/lib">  	 
	  		<fileset dir="../aop-mc-int/output/lib14">
	  			<include name="*.jar" />
	  		</fileset>
	  		<fileset dir="../container/output/lib14">
	  			<include name="*.jar" />
	  		</fileset>
	  		<fileset dir="../dependency/output/lib14">
	  			<include name="*.jar" />
	  		</fileset>
	  		<fileset dir="../kernel/output/lib14">
	  			<include name="*.jar" />
	  		</fileset>  	 
  	  	</copy>

  </target>

  <!-- ================================================================== -->
  <!-- Cleaning                                                           -->
  <!-- ================================================================== -->

  <!-- Clean up all build output -->
  <target name="clean" depends="_buildmagic:clean, modules-clean"
	  description="Cleans up most generated files.">
  </target>

  <!-- Clean up all generated files -->
  <target name="clobber" depends="_buildmagic:clobber, clean, modules-clobber"
	  description="Cleans up all generated files.">
    <delete file="${module.root}/*_run.log"/>
  </target>


  <!-- ================================================================== -->
  <!-- Misc.                                                              -->
  <!-- ================================================================== -->

  <target name="main" depends="most"
	  description="Executes the default target (most).">
	  <mkdir dir="output/lib"/>
	  <copy todir="output/lib">  	 
	  		<fileset dir="../aop-mc-int/output/lib">
	  			<include name="*.jar" />
	  		</fileset>
	  		<fileset dir="../container/output/lib">
	  			<include name="*.jar" />
	  		</fileset>
	  		<fileset dir="../dependency/output/lib">
	  			<include name="*.jar" />
	  		</fileset>
	  		<fileset dir="../deployers/output/lib">
	  			<include name="*.jar" />
	  		</fileset>
	  		<fileset dir="../kernel/output/lib">
	  			<include name="*.jar" />
	  		</fileset>  	 
	  		<fileset dir="../managed/output/lib">
	  			<include name="*.jar" />
	  		</fileset>  	 
	  		<fileset dir="../metatype/output/lib">
	  			<include name="*.jar" />
	  		</fileset>  	 
	  	</copy>
  </target>

  <target name="most" depends="createthirdparty, modules-most"
	  description="Executes all modules and builds most everything."/>

  <target name="help" depends="_buildmagic:help:build"
          description="Show this help message."/>
   <!-- create the thirdparty folder from items in the repository -->
   <!-- then generate a new libraries.ent file and include it in  -->
   <!-- the build                                                 -->
   <target name="createthirdparty" unless="inhibit.downloads"
      depends="check.inhibit.downloads, set.proxy">
      <ant antfile="build-thirdparty.xml" target="generate-lib-file"/>
   </target>

   <!-- check if thirdparty libraries are to be downloaded -->
   <target name="check.inhibit.downloads">
      <condition property="inhibit.downloads">
         <or>
            <uptodate property="dependencies.current"
 	      srcfile="build-thirdparty.xml"
               targetfile="../thirdparty/libraries.ent"/>
            <istrue value="${nodownload}"/>
         </or>
      </condition>
  </target>

  <!-- check if the the user has specied proxy settings -->
  <target name="check.proxy">
    <condition property="hasproxy">
        <and>
            <isset property="proxy.host"/>
            <isset property="proxy.port"/>
            <not>
                <equals arg1="" arg2="${proxy.host}" trim="true"/>
            </not>
            <not>
                <equals arg1="" arg2="${proxy.port}" trim="true"/>
            </not>
        </and>
    </condition>
  </target>

  <!-- set proxy settings -->
  <target name="set.proxy" if="hasproxy" depends="check.proxy">
    <echo>Proxy is set to ${proxy.host}:${proxy.port}</echo>
    <setproxy proxyhost="${proxy.host}" proxyport="${proxy.port}"/>
  </target>

</project>

