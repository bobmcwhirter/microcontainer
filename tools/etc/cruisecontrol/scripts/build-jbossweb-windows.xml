<project name="build-jbossweb-windows" default="copyresults">

    <property name="log.dir" value="${basedir}/logbuild/jbossweb-windows"/>
    <property name="proj.dir" value="../jbossweb-builder/"/>
    <property name="checkout.dir" value="../checkout/jbossweb/"/>
    <property environment="env"/>

    <import file="build-common-targets.xml"/>

    <target name="clean" depends="" description="Cleans checkout directory">
	<delete dir="${checkout.dir}"/>
	<mkdir dir="${checkout.dir}"/>
        <antcall target="clean.checkout">
           <param name="checkout.dir" value="${checkout.dir}"/>
           <param name="artifacts.dir" value="${log.dir}"/>
        </antcall>	
    </target>

    <target name="build" depends="clean" description="Build the jbossweb project">
        <exec executable="ant" resultproperty="build.returncode" failonerror="false" output="${log.dir}/build.log">
            <arg line=" -buildfile ${proj.dir}/build-windows.xml build"/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/>             
        </exec>
        <condition property="build.success">
          <equals arg1="${build.returncode}" arg2="0"/>
        </condition>
        <fail unless="build.success">
          Exit code: ${build.returncode}
          See compile.log in Build Artifacts for details.
        </fail>       
    </target>
    
    <target name="runtestsuite" depends="build" description="Deploys JBossWeb on different platforms and runs the testsuite">   
        <antcall target="runtests">
            <param name="platform" value="windows-i586"/>
            <param name="remote.address" value="10.4.0.47"/>
            <param name="target.os" value="windows"/>
            <param name="buildworld.command" value="dll"/>
            <param name="buildsvc.command" value="d"/>
            <param name="arch" value="x86"/>
        </antcall>
        <antcall target="runtests">
            <param name="platform" value="windows-amd64"/>
            <param name="remote.address" value="10.4.0.47"/>
            <param name="target.os" value="windows"/>
            <param name="buildworld.command" value="dll"/>
            <param name="buildsvc.command" value=""/>
            <param name="arch" value="amd64"/>
        </antcall>      
        <antcall target="runtests">
            <param name="platform" value="windows-ia64"/>
            <param name="remote.address" value="10.4.0.50"/>
            <param name="target.os" value="windows"/>
            <param name="buildworld.command" value="sdk"/>
            <param name="buildsvc.command" value=""/>
            <param name="arch" value="ia64"/>
        </antcall>
    </target>

    <target name="runtests">
        <mkdir dir="${log.dir}/${platform}"/>
        <delete dir="${proj.dir}/output/autobench"/>
        <mkdir dir="${proj.dir}/output/autobench"/>
        <exec executable="ant" resultproperty="tests.returncode" failonerror="false" output="${log.dir}/${platform}/${platform}-build.log" append="true">
            <arg line=" -buildfile ${proj.dir}/build-windows.xml package startJBossWeb 
            -Djbossweb.address=${remote.address} -Ddaemon.address=${remote.address} 
            -Dplatform=${platform} -Dtarget.os=${target.os}
            -Dbuildworld.command=${buildworld.command} -Dbuildsvc.command=${buildsvc.command} -Darch=${arch}"/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/>             
        </exec>
        <copy todir="${log.dir}/${platform}">
           <fileset dir="${proj.dir}/output/autobench" includes="*.*"/>
        </copy>
        <copy todir="${log.dir}/${platform}">
           <fileset dir="${proj.dir}/output/${platform}" includes="*.zip"/>
        </copy>        
        <condition property="tests.success">
          <equals arg1="${tests.returncode}" arg2="0"/>
        </condition>
        <fail unless="tests.success">
          Exit code: ${tests.returncode}
          See ${platform}/${platform}-build.log in Build Artifacts for details.
        </fail>        
    </target>

</project>
