<project name="build-jbpm-db-testsuite" default="copyresults">

    <property name="cvs.repository" value=":pserver:anonymous@anoncvs.forge.jboss.com:/cvsroot/jbpm"/>
    <property name="log.dir" value="${basedir}/logbuild/jbpm-db-matrix"/>
    <property name="proj.dir" value="../checkout/jbpm-db-matrix"/>
    <property name="jbpm.db" value="${proj.dir}/jbpm.db"/>
    <property environment="env"/>
    
 
    <import file="build-common-targets.xml"/>

    <target name="clean" depends="" description="Cleans checkout directory">
        <sequential>
            <antcall target="clean.checkout">
               <param name="checkout.dir" value="${proj.dir}"/>
               <param name="artifacts.dir" value="${log.dir}"/>
            </antcall>
            <antcall target="version">
                <param name="java.home" value="${env.JAVA_HOME}"/>
                <param name="ant.home" value="${env.ANT_HOME}"/>
            </antcall>
        </sequential>
    </target>

    <target name="getcode" depends="clean" description="Update packages from CVS">
        <cvs command="co -P -r branch_3_1 jbpm.3" cvsroot="${cvs.repository}" compressionlevel="3" dest="${proj.dir}" package="jbpm.3" output="${log.dir}/cvsco.log"/>     
        <cvs command="co -P jbpm.db" cvsroot="${cvs.repository}" compressionlevel="3" dest="${proj.dir}" package="jbpm.db" output="${log.dir}/cvsco.log" append="true"/>             
    </target>

    <target name="build" depends="" description="Build the jbpm.3 project">
        <sequential>
        <delete file="${jbpm.db}/${db.name}/hibernate.properties"/>
        <copy file="jbpm/${db.name}.properties" tofile="${jbpm.db}/${db.name}/hibernate.properties"/>
        
        <exec executable="ant" resultproperty="build.returncode" failonerror="false"  dir="${jbpm.db}" output="${log.dir}/build.log">
	    <arg line="prepare"/>
        </exec>
        <condition property="build.success">
          <equals arg1="${build.returncode}" arg2="0"/>
        </condition>
        <fail unless="build.success">
          Exit code: ${build.returncode}
          See build.log in Build Artifacts for details.
        </fail>
        </sequential>
    </target>
    
    <target name="tests" depends="build" description="Runs the jbpm tests">   
        <exec executable="ant" failonerror="true"  dir="${jbpm.db}" output="${log.dir}/scripts.log">
	    <arg line="${db.name}.scripts"/>
        </exec>        
        <exec executable="ant" failonerror="false"  dir="${jbpm.db}"
	      resultproperty="tests.returncode" output="${log.dir}/tests.log">
	    <arg line="${db.name}.test"/>
        </exec>
        <condition property="tests.success">
          <equals arg1="${tests.returncode}" arg2="0"/>
        </condition>
        <fail unless="tests.success">
          Exit code: ${tests.returncode}
          See tests.log in Build Artifacts for details.
        </fail>
    </target>

    <target name="copyresults" depends="tests" description="Copies test results to the logbuild directory">
        <mkdir dir="${log.dir}/results"/>
        <copy todir="${log.dir}/results">
           <fileset dir="${jbpm.db}/build/${db.name}/testresults"/>
        </copy>
        <antcall target="test-build-failure">
            <param name="fileset.dir" value="${log.dir}/results/xml"/>
            <param name="fileset.includes" value="TEST-*.xml"/>
            <param name="error.text" value="errors=&quot;0&quot;"/>
            <param name="failure.text" value="failures=&quot;0&quot;"/>
        </antcall>
    </target>

   <target name="copyjbpmconfig" description="Copies jbpm.test.cfg.xml to use db specific hibernate.properties">
        <delete file="${proj.dir}/jbpm.3/src/java.jbpm.test/org/jbpm/jbpm.test.cfg.xml"/>
        <copy file="jbpm/jbpm.test.cfg.xml" todir="${proj.dir}/jbpm.3/src/java.jbpm.test/org/jbpm/"/>   	
   </target>
   
   
   <target name="hsqldb">
        <antcall target="copyresults">
            <param name="db.name" value="hsqldb"/>
        </antcall>
   </target>
   
   <target name="mysql">
        <antcall target="copyjbpmconfig"/>
        <antcall target="copyresults">
            <param name="db.name" value="mysql"/>
        </antcall>
   </target>   

   <target name="oracle">
   	<copy file="/opt/jdbc-drivers/ojdbc14.jar" todir="${jbpm.db}/oracle/lib"/>
   	<antcall target="copyjbpmconfig"/>
        <antcall target="copyresults">
            <param name="db.name" value="oracle"/>
        </antcall>
   </target>    
   
   <target name="sybase">
   	<antcall target="copyjbpmconfig"/>
        <antcall target="copyresults">
            <param name="db.name" value="sybase"/>
        </antcall>
   </target>    

   <target name="db2">
        <copy file="/opt/jdbc-drivers/db2jcc.jar" todir="${jbpm.db}/db2/lib"/>
        <copy file="/opt/jdbc-drivers/db2jcc_license_cu.jar" todir="${jbpm.db}/db2/lib"/>
   	<antcall target="copyjbpmconfig"/>
        <antcall target="copyresults">
            <param name="db.name" value="db2"/>
        </antcall>
   </target> 
   
   <target name="mssql">
        <antcall target="copyjbpmconfig"/>
        <antcall target="copyresults">
            <param name="db.name" value="mssql"/>
        </antcall>
   </target>   
</project>

