<project name="build-jboss-portal" default="jboss.shutdown">

    <property name="cvs.repository" value=":pserver:anonymous@anoncvs.forge.jboss.com:/cvsroot/jboss"/>
    <property name="log.dir" value="${basedir}/logbuild/${jboss.dir}"/>
   
    <property environment="env"/>
    <property name="java.home" value="${env.JAVA_HOME}"/>
    <property name="jboss.host" value="localhost"/>
    <property name="jboss.port" value="8080"/>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
       <classpath>
         <pathelement location="/opt/apache-ant-1.6.2/lib/ant-contrib.jar"/>
       </classpath>
    </taskdef>
   
    <import file="build-common-targets.xml"/>

    <target name="clean" depends="" description="Cleans checkout directory">
	<sequential>
            <antcall target="clean.checkout">
               <param name="checkout.dir" value="../checkout/${jboss.dir}"/>
               <param name="artifacts.dir" value="${log.dir}"/>
            </antcall>
            <antcall target="version">
               <param name="java.home" value="${env.JAVA_HOME}"/>
               <param name="ant.home" value="${env.ANT_HOME}"/>
            </antcall>
        </sequential>
    </target>

    <target name="getcode" depends="clean" description="Update packages from CVS">
        <if>
         <equals arg1="${cvs.branch}" arg2="HEAD" />
         <then>
           <property name="cvs.branch.opt" value=""/>
         </then>
         <else>
           <property name="cvs.branch.opt" value=" -r ${cvs.branch}"/>
         </else>
        </if>
        <cvs command="co ${cvs.branch.opt} ${cvs.module}" cvsroot="${cvs.repository}" compressionlevel="3" dest="../checkout" failonerror="true" output="${log.dir}/cvsco.log"/>
    </target>

    <target name="runtestsuite" description="Deploys Portal on different JBoss homes and runs the testsuite">
        <mkdir dir="${log.dir}/results"/>
       <antcall target="runtests">
            <param name="jboss.home.dir" value="../checkout/jboss-builds/jboss-4.0.x/jboss-4.0.5.CR1"/>
            <param name="jboss.version.info" value="4_0_x"/>
        </antcall>      
        <antcall target="runtests">
            <param name="jboss.home.dir" value="../../jboss-4.0.4.GA"/>
            <param name="jboss.version.info" value="4_0_4_GA"/>
        </antcall>
        <antcall target="runtests">
            <param name="jboss.home.dir" value="../checkout/jboss-builds/jboss-head/jboss-5.0.0.Beta"/>
            <param name="jboss.version.info" value="HEAD"/>
        </antcall>
        <antcall target="copyresults"/>
    </target>


    <target name="runtests">
    	<mkdir dir="${log.dir}/${jboss.version.info}-logs"/>
        <antcall target="clean-portal">
            <param name="jboss.version" value="${jboss.version.info}"/>
        </antcall>     
        <antcall target="build">
            <param name="jboss.version" value="${jboss.version.info}"/>
        </antcall>         
        <tests jboss.home="${jboss.home.dir}" jboss.version="${jboss.version.info}"/>
        <copylogs jboss.home="${jboss.home.dir}" jboss.version="${jboss.version.info}"/>
    </target> 
    
    
    <target name="clean-portal">
        <exec executable="ant"  failonerror="true" output="${log.dir}/${jboss.version}-logs/clean.log">
            <arg line=" -buildfile ../checkout/${jboss.dir}/build/build.xml clean"/>
        </exec>
    </target>
    
    <target name="build">
	<sequential>
        <exec executable="ant"  failonerror="true" output="${log.dir}/${jboss.version}-logs/compile.log">
            <arg line=" -buildfile ../checkout/${jboss.dir}/build/build.xml"/>
        </exec>
        <exec executable="ant"  failonerror="true" output="${log.dir}/${jboss.version}-logs/compile.log" append="true">
            <arg line=" -buildfile ../checkout/${jboss.dir}/test/build.xml"/>
        </exec>        
        </sequential>
    </target>
    
    <macrodef name="tests">
    <attribute name="jboss.home" default=""/>    
    <attribute name="jboss.version" default=""/>
        <sequential>
        <exec executable="ant" output="${log.dir}/@{jboss.version}-logs/tests.log" append="true">
            <arg line=" -buildfile ../checkout/${jboss.dir}/testsuite/build.xml -Djboss-junit-configuration=@{jboss.version} tests"/>
            <env key="PATH" path="/opt/apache-ant-1.6.5/bin:${env.PATH}"/>            
            <env key="JBOSS_HOME" path="@{jboss.home}"/>   
            <env key="ANT_HOME" path="/opt/apache-ant-1.6.5"/>              
        </exec>        
        </sequential>
    </macrodef>    

    <target name="copyresults">
       <sequential>
       <mkdir dir="${log.dir}/results"/>
       <copy todir="${log.dir}/results">
           <fileset dir="../checkout/${jboss.dir}/testsuite/output/reports"/>
       </copy>
        <antcall target="test-build-failure">
            <param name="fileset.dir" value="${log.dir}/results"/>
            <param name="fileset.includes" value="TEST-*.xml"/>
            <param name="error.text" value="errors=&quot;0&quot;"/>
            <param name="failure.text" value="failures=&quot;0&quot;"/>
        </antcall>
        </sequential>
    </target>   

    <macrodef name="copylogs">
    <attribute name="jboss.home" default=""/>
    <attribute name="jboss.version" default=""/>    
        <sequential>
        <copy todir="${log.dir}/@{jboss.version}-logs">
           <fileset dir="@{jboss.home}/server/default/" includes="log/*.log"/>
        </copy>        
        <copy todir="${log.dir}/@{jboss.version}-logs">
           <fileset dir="../checkout/${jboss.dir}/testsuite/output/logs"/>
        </copy>
        </sequential>
    </macrodef>
</project>
