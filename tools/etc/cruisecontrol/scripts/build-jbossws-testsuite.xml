<project name="build-jbossws-testsuite" default="copyresults">

    <property name="log.dir" value="${basedir}/logbuild/${jboss.dir}"/>
    <property name="proj.dir" value="../checkout/${jboss.dir}"/>
    <property environment="env"/>

    <property file="cruisecontrol.properties"/>

    <path id="project.classpath">
        <fileset dir="../../svnant/lib/">
            <include name="*.jar"/>
        </fileset>
    </path>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
       <classpath>
         <pathelement location="/opt/apache-ant-1.6.2/lib/ant-contrib.jar"/>
       </classpath>
    </taskdef> 
    
    <taskdef resource="svntask.properties" classpathref="project.classpath"/>
    
    <import file="build-common-targets.xml"/>

    <property name="jbossws-4.0-testsuite-1.4-jdk" value="${java14}"/>
    <property name="jbossws-4.0-testsuite-1.5-jdk" value="${java15}"/>
    <property name="jbossws-head-testsuite-1.5-jdk" value="${java15}"/>
    <propertycopy name="java.home.dir" from="${jboss.dir}-jdk"/>
      
    <property name="jbossws-4.0-testsuite-1.4-url" value="http://anonsvn.jboss.org/repos/jbossws/branches/jbossws-1.0"/>
    <property name="jbossws-4.0-testsuite-1.5-url" value="http://anonsvn.jboss.org/repos/jbossws/branches/jbossws-1.0"/>
    <property name="jbossws-head-testsuite-1.5-url" value="http://anonsvn.jboss.org/repos/jbossws/trunk"/>
    <propertycopy name="jbossws.svn.url" from="${jboss.dir}-url"/>
    
    <property name="jbossws-4.0-testsuite-1.4-jboss" value="${jboss-40x-14}"/>
    <property name="jbossws-4.0-testsuite-1.5-jboss" value="${jboss-40x-15}"/>
    <property name="jbossws-head-testsuite-1.5-jboss" value="${jboss-head}"/>
    <propertycopy name="jboss.home" from="${jboss.dir}-jboss"/>   
    
    <property name="jbossws-4.0-testsuite-1.5-properties" value="jbossws-4.0.properties"/>
    <property name="jbossws-head-testsuite-1.5-properties" value="jbossws-head.properties"/>
    <propertycopy name="jbossws.properties" from="${jboss.dir}-properties"/>      


    <target name="clean" depends="" description="Cleans checkout directory">
        <antcall target="clean.checkout">
           <param name="checkout.dir" value="${proj.dir}"/>
           <param name="artifacts.dir" value="${log.dir}"/>
        </antcall>
    </target>

    <target name="getcode" depends="clean" description="Update packages from CVS">
        <svn>
            <checkout url="${jbossws.svn.url}" destPath="${proj.dir}"/>
        </svn>    
    </target>

    <target name="build" depends="getcode" description="Build jbossws project">
	<sequential>
	<copy file="${jbossws.properties}" tofile="${proj.dir}/ant.properties"/>
        <exec executable="ant" failonerror="false" dir="${proj.dir}" resultproperty="build.returncode" output="${log.dir}/compilejbossws.log">
            <arg line="-Djboss.home=${jboss.home}"/>
            <env key="PATH" path="${java15}/bin:${ant-ws}/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="${java15}"/>
            <env key="ANT_HOME" path="${ant-ws}"/>
        </exec>
        <condition property="build.success">
          <equals arg1="${build.returncode}" arg2="0"/>
        </condition>
        <fail unless="build.success">
          Exit code: ${build.returncode}
          See compilejbossws.log in Build Artifacts for details.
        </fail>
        </sequential>
    </target>

    <target name="tests" depends="build" description="Runs the jbossws tests">
	<sequential>
	<antcall target="kill"/>

        <exec executable="ant" failonerror="false" dir="${proj.dir}"  output="${log.dir}/deploy.log">
            <arg line="deploy-jbossws -Djboss.home=${jboss.home}"/>
            <env key="PATH" path="${java.home.dir}/bin:${ant-ws}/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="${java.home.dir}"/>
            <env key="ANT_HOME" path="${ant-ws}"/>
        </exec>
	
	<antcall target="startserver">
	   <param name="jboss.home" value="${jboss.home}"/>
	   <param name="java.home.dir" value="${java.home.dir}"/>
	   <param name="config" value="default"/>
	   <param name="node" value="localhost"/>
	</antcall>
	
        <exec executable="ant" failonerror="false" dir="${proj.dir}/src/test"  resultproperty="tests.returncode"  output="${log.dir}/tests.log">
            <arg line="clean tests -Djboss.home=${jboss.home}"/>
            <env key="PATH" path="${java.home.dir}/bin:${ant-ws}/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="${java.home.dir}"/>
            <env key="ANT_HOME" path="${ant-ws}"/>
        </exec>        

	<antcall target="stopserver">
	   <param name="jboss.home" value="${jboss.home}"/>
	   <param name="java.home.dir" value="${java.home.dir}"/>
	   <param name="node" value="localhost"/>
	</antcall>
	<antcall target="kill"/>
        <condition property="tests.success">
          <equals arg1="${tests.returncode}" arg2="0"/>
        </condition>
        <fail unless="tests.success">
          Exit code: ${tests.returncode}
          See tests.log in Build Artifacts for details.
        </fail>
        </sequential>	
    </target>

    <target name="copyresults" depends="tests" description="Copies test results to the logbuild directory">
        <mkdir dir="${log.dir}/results"/>
        <copy todir="${log.dir}/results">
           <fileset dir="${proj.dir}/output/tests/reports"/>
        </copy>
        <copy todir="${log.dir}/results">
           <fileset dir="${proj.dir}/output/tests/reports/html"/>
        </copy>
        <delete dir="${log.dir}/results/html"/>
        <antcall target="test-build-failure">
            <param name="fileset.dir" value="${log.dir}/results"/>
            <param name="fileset.includes" value="TEST-*.xml"/>
            <param name="error.text" value="errors=&quot;0&quot;"/>
            <param name="failure.text" value="failures=&quot;0&quot;"/>
        </antcall>
    </target>
</project>