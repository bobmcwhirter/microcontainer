<project name="build-jbossweb" default="copyresults">

    <property name="log.dir" value="${basedir}/logbuild/jbossweb"/>
    <property name="proj.dir" value="../jbossweb-builder/"/>
    <property name="checkout.dir" value="../checkout/jbossweb/"/>
    <property environment="env"/>

    <import file="build-common-targets.xml"/>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
       <classpath>
         <pathelement location="/opt/apache-ant-1.6.2/lib/ant-contrib.jar"/>
       </classpath>
    </taskdef> 
    
    <target name="clean" depends="" description="Cleans checkout directory">
	<delete dir="${checkout.dir}"/>
	<mkdir dir="${checkout.dir}"/>
        <antcall target="clean.checkout">
           <param name="checkout.dir" value="${checkout.dir}"/>
           <param name="artifacts.dir" value="${log.dir}"/>
        </antcall>	
    </target>

    <target name="build" depends="clean" description="Build the jbossweb project">
        <exec executable="ant" resultproperty="build.returncode" failonerror="false" output="${log.dir}/build.log">
            <arg line=" -buildfile ${proj.dir}/build.xml build"/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/>             
        </exec>
        <condition property="build.success">
          <equals arg1="${build.returncode}" arg2="0"/>
        </condition>
        <fail unless="build.success">
          Exit code: ${build.returncode}
          See compile.log in Build Artifacts for details.
        </fail>       
    </target>
    
    <target name="runtestsuite" depends="build" description="Deploys JBossWeb on different platforms and runs the testsuite">   
        <delete dir="${proj.dir}/output/autobench"/>
        <mkdir dir="${proj.dir}/output/autobench"/>
        
        <mkdir dir="${log.dir}/linux-i686"/>
        <exec executable="ant" resultproperty="linux-i686.tests.returncode" failonerror="false" output="${log.dir}/linux-i686/linux-i686-build.log" append="true">
            <arg line=" -buildfile ${proj.dir}/build.xml package startJBossWeb -Djbossweb.address=10.64.8.240 -Ddaemon.address=10.64.8.240 -Dplatform=linux-i686 -Djava.home.dir=/opt/jdk1.5.0_06 -Dtarget.os=unix"/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/>             
        </exec>
        <copy todir="${log.dir}/linux-i686">
           <fileset dir="${proj.dir}/output/autobench" includes="*.*"/>
        </copy>
        <copy todir="${log.dir}/linux-i686">
           <fileset dir="${proj.dir}/output/linux-i686" includes="*.gz"/>
        </copy> 
        <condition property="linux-i686.tests.success">
           <equals arg1="${linux-i686.tests.returncode}" arg2="0"/>
        </condition>


        <mkdir dir="${log.dir}/linux-ia64"/>
        <exec executable="ant" resultproperty="linux-ia64.tests.returncode" failonerror="false" output="${log.dir}/linux-ia64/linux-ia64-build.log" append="true">
            <arg line=" -buildfile ${proj.dir}/build.xml package startJBossWeb -Djbossweb.address=10.64.68.240 -Ddaemon.address=10.64.68.240 -Dplatform=linux-ia64 -Djava.home.dir=/opt/ia64/jrockit-jdk1.5.0_03 -Dtarget.os=unix"/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/>             
        </exec>
        <copy todir="${log.dir}/linux-ia64">
           <fileset dir="${proj.dir}/output/autobench" includes="*.*"/>
        </copy>
        <copy todir="${log.dir}/linux-ia64">
           <fileset dir="${proj.dir}/output/linux-ia64" includes="*.gz"/>
        </copy> 
        <condition property="linux-ia64.tests.success">
           <equals arg1="${linux-ia64.tests.returncode}" arg2="0"/>
        </condition>
        
        
        <mkdir dir="${log.dir}/linux-x86_64"/>
        <exec executable="ant" resultproperty="linux-x86_64.tests.returncode" failonerror="false" output="${log.dir}/linux-x86_64/linux-x86_64-build.log" append="true">
            <arg line=" -buildfile ${proj.dir}/build.xml package startJBossWeb -Djbossweb.address=10.64.64.240 -Ddaemon.address=10.64.64.240 -Dplatform=linux-x86_64 -Djava.home.dir=/opt/x86_64/jdk1.5.0_05 -Dtarget.os=unix"/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/>             
        </exec>
        <copy todir="${log.dir}/linux-x86_64">
           <fileset dir="${proj.dir}/output/autobench" includes="*.*"/>
        </copy>
        <copy todir="${log.dir}/linux-x86_64">
           <fileset dir="${proj.dir}/output/linux-x86_64" includes="*.gz"/>
        </copy> 
        <condition property="linux-x86_64.tests.success">
           <equals arg1="${linux-x86_64.tests.returncode}" arg2="0"/>
        </condition>
        
        
        <mkdir dir="${log.dir}/solaris-sparc"/>
        <exec executable="ant" resultproperty="solaris-sparc.tests.returncode" failonerror="false" output="${log.dir}/solaris-sparc/solaris-sparc-build.log" append="true">
            <arg line=" -buildfile ${proj.dir}/build.xml package startJBossWeb -Djbossweb.address=10.64.44.240 -Ddaemon.address=10.64.44.240 -Dplatform=solaris-sparc -Djava.home.dir=/opt/jdk1.5.0_05 -Dtarget.os=unix"/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/>             
        </exec>
        <copy todir="${log.dir}/solaris-sparc">
           <fileset dir="${proj.dir}/output/autobench" includes="*.*"/>
        </copy>
        <copy todir="${log.dir}/solaris-sparc">
           <fileset dir="${proj.dir}/output/solaris-sparc" includes="*.gz"/>
        </copy> 
        <condition property="solaris-sparc.tests.success">
           <equals arg1="${solaris-sparc.tests.returncode}" arg2="0"/>
        </condition>
        
        
        <fail unless="linux-i686.tests.success">
          Exit code: ${linux-i686.tests.returncode}
          See linux-i686/linux-i686-build.log in Build Artifacts for details.
        </fail>
        <fail unless="linux-ia64.tests.success">
          Exit code: ${linux-ia64.tests.returncode}
          See linux-ia64/linux-ia64-build.log in Build Artifacts for details.
        </fail>
        <fail unless="linux-x86_64.tests.success">
          Exit code: ${linux-x86_64.tests.returncode}
          See linux-x86_64/linux-x86_64-build.log in Build Artifacts for details.
        </fail>
        <fail unless="solaris-sparc.tests.success">
          Exit code: ${solaris-sparc.tests.returncode}
          See solaris-sparc/solaris-sparc-build.log in Build Artifacts for details.
        </fail>
    </target>

</project>
