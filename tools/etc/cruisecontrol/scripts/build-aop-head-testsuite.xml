<project name="build-aop-head-testsuite" default="copyresults">

    <property name="cvs.repository" value=":pserver:anonymous@anoncvs.forge.jboss.com:/cvsroot/jboss"/>
    <property name="log.dir" value="${basedir}/logbuild/${jboss.dir}"/>
    <property environment="env"/>

    <import file="build-common-targets.xml"/>

    <target name="clean" depends="" description="Cleans checkout directory">
	<sequential>
            <antcall target="clean.checkout">
               <param name="checkout.dir" value="../checkout/${jboss.dir}"/>
               <param name="artifacts.dir" value="${log.dir}"/>
            </antcall>
            <antcall target="version">
               <param name="java.home" value="/opt/jdk1.5.0_03"/>
               <param name="ant.home" value="${env.ANT_HOME}"/>
            </antcall>
        </sequential>
    </target>

    <target name="getcode" depends="clean" description="Update packages from CVS">
        <cvs command="co -d ${jboss.dir} jboss-head" cvsroot="${cvs.repository}" compressionlevel="3" dest="../checkout" failonerror="true" output="${log.dir}/cvsco.log"/>
    </target>

    <target name="build" depends="getcode" description="Build the jboss-head project">
	<sequential>
        <exec executable="ant" failonerror="false" dir="../checkout/${jboss.dir}/build" resultproperty="build.returncode" output="${log.dir}/compilejbosshead.log">
            <arg line=""/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/>            
        </exec>
        <antcall target="copylogs">
           <param name="dest.dir" value="${log.dir}"/>
           <param name="proj.dir" value="${jboss.dir}"/>
        </antcall>
        <condition property="build.success">
          <equals arg1="${build.returncode}" arg2="0"/>
        </condition>
        <fail unless="build.success">
          Exit code: ${build.returncode}
          See compilejbosshead.log in Build Artifacts for details.
        </fail>
        </sequential>
    </target>

    <target name="buildaop" depends="build" description="Build the aop project">
	<sequential>
        <exec executable="ant" failonerror="false" dir="../checkout/${jboss.dir}/aop/" resultproperty="buildaop.returncode"  output="${log.dir}/compileaop.log">
            <arg line=""/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/> 
            <env key="JROCKIT_HOME" path="/opt/jrockit-jdk1.5.0_03"/>
        </exec>
        <antcall target="copylogs">
           <param name="dest.dir" value="${log.dir}"/>
           <param name="proj.dir" value="${jboss.dir}/aop"/>
        </antcall>
        <condition property="buildaop.success">
          <equals arg1="${buildaop.returncode}" arg2="0"/>
        </condition>
        <fail unless="buildaop.success">
          Exit code: ${buildaop.returncode}
          See compileaop.log in Build Artifacts for details.
        </fail>
        </sequential>
    </target>

    <target name="tests" depends="buildaop" description="Runs the aop tests">
	<sequential>
        <exec executable="ant" failonerror="false" dir="../checkout/${jboss.dir}/aop/"  resultproperty="tests.returncode"  output="${log.dir}/tests.log">
            <arg line="tests tests-report-html"/>
            <env key="PATH" path="/opt/jdk1.5.0_03/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_03"/> 
            <env key="JROCKIT_HOME" path="/opt/jrockit-jdk1.5.0_03"/>            
        </exec>
        <antcall target="copylogs">
           <param name="dest.dir" value="${log.dir}"/>
           <param name="proj.dir" value="${jboss.dir}"/>
        </antcall>
        <condition property="tests.success">
          <equals arg1="${tests.returncode}" arg2="0"/>
        </condition>
        <fail unless="tests.success">
          Exit code: ${tests.returncode}
          See tests.log in Build Artifacts for details.
        </fail>
        </sequential>	
    </target>

    <target name="copyresults" depends="tests" description="Copies test results to the logbuild directory">
        <mkdir dir="${log.dir}/results"/>
        <copy todir="${log.dir}/results">
           <fileset dir="../checkout/${jboss.dir}/aop/output/reports"/>
        </copy>
        <copy todir="${log.dir}/results">
           <fileset dir="../checkout/j${jboss.dir}/aop/output/reports/html"/>
        </copy>    
	<delete dir="${log.dir}/results/html"/>
        <antcall target="test-build-failure">
            <param name="fileset.dir" value="${log.dir}/results"/>
            <param name="fileset.includes" value="TEST-*.xml"/>
            <param name="error.text" value="errors=&quot;0&quot;"/>
            <param name="failure.text" value="failures=&quot;0&quot;"/>
        </antcall>
    </target>
</project>


