  <project name="build-common-targets">
  <target name="test-build-failure">
       <copy todir="${fileset.dir}/testfailures">
           <fileset dir="${fileset.dir}" includes="${fileset.includes}">
               <or>
                  <not><contains text="${error.text}"/></not>
                  <not><contains text="${failure.text}"/></not>
               </or>
           </fileset>
       </copy>
       <fail message="Build Successful - Tests completed with errors or failures.">
          <condition>
                <available file="${fileset.dir}/testfailures" type="dir"/>
          </condition>
       </fail>
  </target>
  <target name="test-build-failure-jbossas">
       <copy todir="${fileset.dir}/testfailures">
           <fileset dir="${fileset.dir}" includes="${fileset.includes}">
               <or>
                  <contains text="${error.text}"/>
                  <contains text="${failure.text}"/>
               </or>
           </fileset>
       </copy>
       <fail message="Build Successful - Tests completed with errors or failures.">
          <condition>
                <available file="${fileset.dir}/testfailures" type="dir"/>
          </condition>
       </fail>
  </target>
  <target name="version" description="Outputs Version Information">
        <exec dir="." executable="bash" output="${log.dir}/host-version-info.txt" append="true">
            <arg value="-c"/>
            <arg value="${ant.home}/bin/ant -version"/>
        </exec>
        <exec dir="." executable="bash" output="${log.dir}/host-version-info.txt" append="true">
            <arg value="-c"/>
            <arg value="${java.home}/bin/java -version"/>
        </exec>
        <exec dir="." executable="bash" output="${log.dir}/host-version-info.txt" append="true">
            <arg value="-c"/>
            <arg value="uname -a"/>
        </exec>
        <echo message="HostName: ${env.HOSTNAME}" file="${log.dir}/host-version-info.txt" append="true"/>
  </target>
  <target name="kill" description="Kills running jboss processes">
       <sequential>
        <exec dir="." executable="bash">
            <arg value="-c"/>
            <arg value="ps -eaf --columns 1200 | grep run.jar | grep -v grep | awk '{ print $$2; }' | xargs kill"/>
        </exec>
        <exec dir="." executable="bash">
            <arg value="-c"/>
            <arg value="sleep 10"/>
        </exec>
        <exec dir="." executable="bash">
            <arg value="-c"/>
            <arg value="ps -eaf --columns 1200 | grep run.jar | grep -v grep | awk '{ print $$2; }' | xargs kill -9"/>
        </exec>
	</sequential>
  </target>
    <target name="copylogs" description="Copies server logs to the logbuild directory">
        <copy todir="${dest.dir}">
           <fileset dir="../checkout/${proj.dir}/" includes="**/*.log"/>
        </copy>
    </target>

    <target name="clean.checkout" description="Clears the checkout and logbuild directory.">
        <delete includeemptydirs="true">
          <fileset dir="${checkout.dir}" includes="**/*"/>
        </delete>
        <delete dir="${artifacts.dir}"/>
        <mkdir dir="${artifacts.dir}"/>
    </target>

    <target name="test-target-failure" description="Tests the success of a target based on the resultproperty returned.">
        <condition property="${failure.property}">
          <equals arg1="${result.property}" arg2="0"/>
        </condition>
        <fail unless="${failure.property}">
          Exit code: ${result.property}
          ${error.message}
        </fail>
    </target>

    <target name="startserver">
	<java jvm="${java.home.dir}/bin/java" classname="org.jboss.Main" fork="true" spawn="true">
		<arg line="-c ${config} -b ${node}"/>
		<jvmarg value="-Xms32m"/>
		<jvmarg value="-Xmx200m"/>
                <sysproperty key="java.endorsed.dirs" value="${jboss.home}/lib/endorsed"/>		
		<classpath>
			<pathelement path="${jboss.home}/bin/run.jar"/>
			<pathelement path="${java.home.dir}/lib/tools.jar"/>
		</classpath>
	</java>    
    </target>
    
    <target name="stopserver">
	<java jvm="${java.home.dir}/bin/java" classname="org.jboss.Shutdown" fork="true">
		<arg line="--server=jnp://${node}:1099 --shutdown"/>
		<classpath>
			<pathelement path="${jboss.home}/bin/shutdown.jar"/>
		</classpath>
	</java>
    </target>
  </project>

