<project name="build-jbosslabs" default="copyresults">

    <property name="log.dir" value="${basedir}/logbuild/jbosslabs"/>
    <property name="proj.dir" value="../checkout/jbosslabs/"/>
    <property environment="env"/>

    <path id="project.classpath">
        <fileset dir="../../svnant/lib/">
            <include name="*.jar"/>
        </fileset>
    </path>

    <taskdef resource="svntask.properties" classpathref="project.classpath"/>
    
    <import file="build-common-targets.xml"/>

    <target name="clean" depends="" description="Cleans checkout directory">
        <antcall target="clean.checkout">
           <param name="checkout.dir" value="${proj.dir}"/>
           <param name="artifacts.dir" value="${log.dir}"/>
        </antcall>
    </target>

    <target name="getcode" depends="clean" description="Update packages from CVS">
        <svn>
            <checkout url="http://anonsvn.labs.jboss.com/labs/jbosslabs/trunk/portal-extensions" destPath="../checkout/jbosslabs"/>
        </svn>    
    </target>

    <target name="build" depends="getcode" description="Build the jbosslabs project">
    
        <exec dir="${proj.dir}" executable="bash">
            <arg value="-c"/>
            <arg value="sed -e 's/local.server.dir=/local.server.dir=\/home\/cruisecontrol\/jboss-4.0.3SP1/g' build.properties.sample > build.properties"/>
        </exec>
   
        <exec dir="${proj.dir}/jbosswiki" executable="bash">
            <arg value="-c"/>
            <arg value="sed -e 's/local.server.dir=/local.server.dir=\/home\/cruisecontrol\/jboss-4.0.3SP1/g' build.properties.sample > build.properties"/>
        </exec>  
        <exec dir="${proj.dir}/shotoku" executable="bash">
            <arg value="-c"/>
            <arg value="sed -e 's/local.server.dir=/local.server.dir=\/home\/cruisecontrol\/jboss-4.0.3SP1/g' build.properties.sample > build.properties.temp"/>
        </exec>    
        <exec dir="${proj.dir}/shotoku" executable="bash">
            <arg value="-c"/>
            <arg value="sed -e 's/shotoku.root.dir=/shotoku.root.dir=\/home\/cruisecontrol\/work\/checkout\/jbosslabs\/shotoku/g' build.properties.temp > build.properties"/>
        </exec>         
    	<move file="${proj.dir}/forge-login/to-copy/portal-login-ds.xml.sample" tofile="${proj.dir}/forge-login/to-copy/portal-login-ds.xml"/>
    	<move file="${proj.dir}/forge-common/src/etc/org/jboss/forge/common/forge.properties.sample" tofile="${proj.dir}/forge-common/src/etc/org/jboss/forge/common/forge.properties"/>

        <exec dir="${proj.dir}" executable="maven" failonerror="false"  resultproperty="build.returncode" output="${log.dir}/build.log">
            <arg line="all"/>
            <env key="PATH" path="/opt/jdk1.5.0_05/bin:${env.PATH}"/>
            <env key="JAVA_HOME" path="/opt/jdk1.5.0_05/"/>
        </exec>
        
        <antcall target="test-target-failure">
           <param name="failure.property" value="build.success"/>
           <param name="result.property" value="${build.returncode}"/>
           <param name="error.message" value="See build.log in Build Artifacts for details."/>
        </antcall>         
    </target>

    <target name="generatereports" depends="build" description="Generates HTML reports">
      <mkdir dir="${proj.dir}/jbosswiki/wiki-common/target/test-reports/reports"/>
      <junitreport todir="${proj.dir}/jbosswiki/wiki-common/target/test-reports/reports">
         <fileset dir="${proj.dir}/jbosswiki/wiki-common/target/test-reports/">
            <include name="TEST-*.xml"/>
         </fileset>
         <report format="frames"
            todir="${proj.dir}/jbosswiki/wiki-common/target/test-reports/reports"/>
      </junitreport>
    </target>

    <target name="copyresults" depends="generatereports" description="Copies test results to the logbuild directory">
        <sequential>
	<mkdir dir="${log.dir}/results"/>
        <copy todir="${log.dir}/results">
           <fileset dir="${proj.dir}/jbosswiki/wiki-common/target/test-reports/reports"/>
        </copy>
        <copy todir="${log.dir}/results" flatten="true">
           <fileset dir="${proj.dir}/jbosswiki/wiki-common/target/test-reports/" includes="TEST-*.xml"/>
        </copy>
       
        <antcall target="test-build-failure">
            <param name="fileset.dir" value="${log.dir}/results"/>
            <param name="fileset.includes" value="TEST-*.xml"/>
            <param name="error.text" value="errors=&quot;0&quot;"/>
            <param name="failure.text" value="failures=&quot;0&quot;"/>
        </antcall>
	</sequential>
    </target>
</project>